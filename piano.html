<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromatic Cascade - 128 Key MIDI Piano</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00fff9;
            --neon-magenta: #ff00ff;
            --neon-yellow: #ffff00;
            --deep-purple: #0a0015;
            --mid-purple: #1a0033;
            --dark-surface: #0d0019;
            --glow-cyan: 0 0 20px rgba(0, 255, 249, 0.5);
            --glow-magenta: 0 0 20px rgba(255, 0, 255, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, var(--deep-purple) 0%, #000814 50%, var(--mid-purple) 100%);
            color: var(--neon-cyan);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 255, 249, 0.03) 2px, rgba(0, 255, 249, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255, 0, 255, 0.03) 2px, rgba(255, 0, 255, 0.03) 4px);
            pointer-events: none;
            z-index: 1;
        }

        .app-container {
            position: relative;
            z-index: 2;
            padding: 2rem;
            max-width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta), var(--neon-yellow), var(--neon-cyan));
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
            text-shadow: var(--glow-cyan);
            letter-spacing: 0.1em;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            font-family: 'Space Mono', monospace;
            color: var(--neon-magenta);
            margin-top: 1rem;
            font-size: 1.1rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .controls-panel {
            background: rgba(10, 0, 21, 0.8);
            border: 2px solid var(--neon-cyan);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--glow-cyan), inset 0 0 30px rgba(0, 255, 249, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeIn 1s ease-out 0.3s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.9rem;
            color: var(--neon-cyan);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
        }

        .control-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--mid-purple), var(--neon-magenta));
            border-radius: 5px;
            outline: none;
            box-shadow: inset 0 0 10px rgba(255, 0, 255, 0.5);
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--neon-cyan);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--glow-cyan);
            transition: transform 0.2s;
        }

        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .control-group select {
            background: var(--dark-surface);
            color: var(--neon-cyan);
            border: 2px solid var(--neon-magenta);
            padding: 0.7rem;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: var(--glow-magenta);
            transition: all 0.3s;
        }

        .control-group select:hover {
            border-color: var(--neon-cyan);
            box-shadow: var(--glow-cyan);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--neon-magenta), var(--neon-cyan));
            color: var(--deep-purple);
            border: none;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 255, 249, 0.8);
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .piano-container {
            background: rgba(13, 0, 25, 0.9);
            border: 3px solid var(--neon-magenta);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--glow-magenta), inset 0 0 50px rgba(255, 0, 255, 0.1);
            overflow-x: auto;
            animation: fadeIn 1s ease-out 0.6s both;
        }

        .octave-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .octave-btn {
            padding: 0.5rem 1rem;
            background: var(--dark-surface);
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            border-radius: 6px;
            font-family: 'Orbitron', monospace;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .octave-btn.active {
            background: var(--neon-cyan);
            color: var(--deep-purple);
            box-shadow: var(--glow-cyan);
        }

        .octave-btn:hover {
            transform: scale(1.05);
        }

        .piano-keyboard {
            display: flex;
            justify-content: center;
            position: relative;
            height: 200px;
            min-width: max-content;
        }

        .piano-key {
            position: relative;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 0.5rem;
        }

        .white-key {
            width: 50px;
            height: 200px;
            background: linear-gradient(180deg, #ffffff 0%, #e0e0e0 100%);
            border: 2px solid #000;
            border-radius: 0 0 5px 5px;
            z-index: 1;
            box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.1);
        }

        .white-key:hover {
            background: linear-gradient(180deg, var(--neon-cyan) 0%, #b0f0ff 100%);
            box-shadow: var(--glow-cyan), inset 0 -5px 10px rgba(0, 255, 249, 0.3);
        }

        .white-key.active {
            background: linear-gradient(180deg, var(--neon-magenta) 0%, #ff66ff 100%);
            box-shadow: var(--glow-magenta);
            transform: translateY(2px);
        }

        .black-key {
            width: 30px;
            height: 120px;
            background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
            border: 2px solid var(--neon-cyan);
            border-radius: 0 0 3px 3px;
            position: absolute;
            z-index: 2;
            color: var(--neon-cyan);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(0, 255, 249, 0.2);
        }

        .black-key:hover {
            background: linear-gradient(180deg, var(--neon-magenta) 0%, #660066 100%);
            box-shadow: var(--glow-magenta), 0 5px 15px rgba(255, 0, 255, 0.5);
        }

        .black-key.active {
            background: linear-gradient(180deg, var(--neon-yellow) 0%, #cccc00 100%);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
            transform: translateY(2px);
        }

        .visualization {
            background: rgba(10, 0, 21, 0.8);
            border: 2px solid var(--neon-yellow);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
            animation: fadeIn 1s ease-out 0.9s both;
        }

        .visualization h3 {
            color: var(--neon-yellow);
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.1em;
        }

        .frequency-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            gap: 2px;
            background: var(--dark-surface);
            border-radius: 10px;
            padding: 1rem;
        }

        .frequency-bar {
            flex: 1;
            background: linear-gradient(180deg, var(--neon-cyan), var(--neon-magenta));
            border-radius: 3px 3px 0 0;
            transition: height 0.1s;
            min-height: 2px;
            box-shadow: 0 0 10px rgba(0, 255, 249, 0.5);
        }

        .midi-info {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--dark-surface);
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            color: var(--neon-yellow);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .white-key {
                width: 35px;
            }
            
            .black-key {
                width: 22px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const BLACK_KEY_POSITIONS = [1, 3, 6, 8, 10]; // Positions in the chromatic scale

        function PianoApp() {
            const [synth, setSynth] = useState(null);
            const [activeNotes, setActiveNotes] = useState(new Set());
            const [currentOctave, setCurrentOctave] = useState(4);
            const [volume, setVolume] = useState(-10);
            const [attack, setAttack] = useState(0.005);
            const [decay, setDecay] = useState(0.1);
            const [sustain, setSustain] = useState(0.3);
            const [release, setRelease] = useState(1);
            const [waveform, setWaveform] = useState('sine');
            const [frequencyData, setFrequencyData] = useState(new Array(32).fill(0));
            const [midiAccess, setMidiAccess] = useState(null);
            const [midiDevices, setMidiDevices] = useState([]);
            const [selectedBackend, setSelectedBackend] = useState('tonejs');
            const fileInputRef = useRef(null);
            const analyserRef = useRef(null);

            useEffect(() => {
                initializeAudio();
                initializeMIDI();
                
                return () => {
                    if (synth) {
                        synth.dispose();
                    }
                };
            }, []);

            useEffect(() => {
                if (synth) {
                    synth.volume.value = volume;
                    synth.envelope.attack = attack;
                    synth.envelope.decay = decay;
                    synth.envelope.sustain = sustain;
                    synth.envelope.release = release;
                    
                    // Update oscillator type
                    synth.oscillator.type = waveform;
                }
            }, [volume, attack, decay, sustain, release, waveform, synth]);

            const initializeAudio = async () => {
                await Tone.start();
                
                const newSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: waveform },
                    envelope: {
                        attack: attack,
                        decay: decay,
                        sustain: sustain,
                        release: release
                    },
                    volume: volume
                }).toDestination();

                // Add analyzer for visualization
                const analyser = new Tone.Analyser('fft', 32);
                newSynth.connect(analyser);
                analyserRef.current = analyser;

                setSynth(newSynth);

                // Update visualization
                const updateVisualization = () => {
                    if (analyserRef.current) {
                        const values = analyserRef.current.getValue();
                        setFrequencyData([...values]);
                    }
                    requestAnimationFrame(updateVisualization);
                };
                updateVisualization();
            };

            const initializeMIDI = async () => {
                try {
                    const access = await navigator.requestMIDIAccess();
                    setMidiAccess(access);
                    
                    const devices = [];
                    for (let input of access.inputs.values()) {
                        devices.push(input);
                        input.onmidimessage = handleMIDIMessage;
                    }
                    setMidiDevices(devices);
                } catch (error) {
                    console.log('MIDI not available:', error);
                }
            };

            const handleMIDIMessage = (message) => {
                const [command, note, velocity] = message.data;
                
                // Note on: 144, Note off: 128
                if (command === 144 && velocity > 0) {
                    const noteName = midiNoteToName(note);
                    playNote(noteName);
                } else if (command === 128 || (command === 144 && velocity === 0)) {
                    const noteName = midiNoteToName(note);
                    stopNote(noteName);
                }
            };

            const midiNoteToName = (midiNote) => {
                const octave = Math.floor(midiNote / 12) - 1;
                const noteIndex = midiNote % 12;
                return NOTES[noteIndex] + octave;
            };

            const playNote = (note) => {
                if (synth) {
                    synth.triggerAttack(note);
                    setActiveNotes(prev => new Set(prev).add(note));
                }
            };

            const stopNote = (note) => {
                if (synth) {
                    synth.triggerRelease(note);
                    setActiveNotes(prev => {
                        const newSet = new Set(prev);
                        newSet.delete(note);
                        return newSet;
                    });
                }
            };

            const handleKeyPress = (note) => {
                playNote(note);
            };

            const handleKeyRelease = (note) => {
                stopNote(note);
            };

            const loadMIDIFile = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // This would require a MIDI parser library
                // For now, we'll show a message
                alert('MIDI file parsing requires backend integration. File: ' + file.name);
                
                // In a full implementation, you would:
                // 1. Parse the MIDI file
                // 2. Extract notes and timing
                // 3. Play back using Tone.js Transport
            };

            const renderOctaveKeys = (octave) => {
                const keys = [];
                let whiteKeyIndex = 0;

                for (let i = 0; i < 12; i++) {
                    const note = NOTES[i];
                    const fullNote = note + octave;
                    const isBlack = note.includes('#');

                    if (!isBlack) {
                        keys.push(
                            <div
                                key={fullNote}
                                className={`piano-key white-key ${activeNotes.has(fullNote) ? 'active' : ''}`}
                                onMouseDown={() => handleKeyPress(fullNote)}
                                onMouseUp={() => handleKeyRelease(fullNote)}
                                onMouseLeave={() => handleKeyRelease(fullNote)}
                                onTouchStart={(e) => { e.preventDefault(); handleKeyPress(fullNote); }}
                                onTouchEnd={(e) => { e.preventDefault(); handleKeyRelease(fullNote); }}
                            >
                                {note}{octave}
                            </div>
                        );
                        whiteKeyIndex++;
                    }
                }

                // Add black keys
                let blackKeyOffset = 0;
                for (let i = 0; i < 12; i++) {
                    const note = NOTES[i];
                    const fullNote = note + octave;
                    const isBlack = note.includes('#');

                    if (isBlack) {
                        const position = (blackKeyOffset * 50) + 35; // Offset calculation
                        keys.push(
                            <div
                                key={fullNote}
                                className={`piano-key black-key ${activeNotes.has(fullNote) ? 'active' : ''}`}
                                style={{ left: `${position}px` }}
                                onMouseDown={() => handleKeyPress(fullNote)}
                                onMouseUp={() => handleKeyRelease(fullNote)}
                                onMouseLeave={() => handleKeyRelease(fullNote)}
                                onTouchStart={(e) => { e.preventDefault(); handleKeyPress(fullNote); }}
                                onTouchEnd={(e) => { e.preventDefault(); handleKeyRelease(fullNote); }}
                            >
                                {note}{octave}
                            </div>
                        );
                    }
                    
                    if (!isBlack) {
                        blackKeyOffset++;
                    }
                }

                return keys;
            };

            return (
                <div className="app-container">
                    <div className="header">
                        <h1>CHROMATIC CASCADE</h1>
                        <p>128-Key MIDI Piano Synthesizer</p>
                    </div>

                    <div className="controls-panel">
                        <div className="controls-grid">
                            <div className="control-group">
                                <label>Volume: {volume} dB</label>
                                <input 
                                    type="range" 
                                    min="-40" 
                                    max="0" 
                                    value={volume}
                                    onChange={(e) => setVolume(parseFloat(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>Attack: {attack}s</label>
                                <input 
                                    type="range" 
                                    min="0.001" 
                                    max="2" 
                                    step="0.001"
                                    value={attack}
                                    onChange={(e) => setAttack(parseFloat(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>Decay: {decay}s</label>
                                <input 
                                    type="range" 
                                    min="0.001" 
                                    max="2" 
                                    step="0.001"
                                    value={decay}
                                    onChange={(e) => setDecay(parseFloat(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>Sustain: {sustain}</label>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="1" 
                                    step="0.01"
                                    value={sustain}
                                    onChange={(e) => setSustain(parseFloat(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>Release: {release}s</label>
                                <input 
                                    type="range" 
                                    min="0.001" 
                                    max="5" 
                                    step="0.001"
                                    value={release}
                                    onChange={(e) => setRelease(parseFloat(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>Waveform</label>
                                <select value={waveform} onChange={(e) => setWaveform(e.target.value)}>
                                    <option value="sine">Sine</option>
                                    <option value="square">Square</option>
                                    <option value="sawtooth">Sawtooth</option>
                                    <option value="triangle">Triangle</option>
                                </select>
                            </div>

                            <div className="control-group">
                                <label>Backend</label>
                                <select value={selectedBackend} onChange={(e) => setSelectedBackend(e.target.value)}>
                                    <option value="tonejs">Tone.js (Client)</option>
                                    <option value="python">Python Backend</option>
                                    <option value="go">Go Backend</option>
                                    <option value="rust">Rust Backend</option>
                                </select>
                            </div>
                        </div>

                        <div className="button-group">
                            <div className="file-input-wrapper">
                                <button className="btn">
                                    <span>Load MIDI File</span>
                                </button>
                                <input 
                                    ref={fileInputRef}
                                    type="file" 
                                    accept=".mid,.midi"
                                    onChange={loadMIDIFile}
                                />
                            </div>
                            <button className="btn" onClick={() => setActiveNotes(new Set())}>
                                <span>Clear All Notes</span>
                            </button>
                            <button className="btn" onClick={initializeAudio}>
                                <span>Reset Synth</span>
                            </button>
                        </div>

                        {midiDevices.length > 0 && (
                            <div className="midi-info">
                                <strong>MIDI Devices Connected:</strong> {midiDevices.map(d => d.name).join(', ')}
                            </div>
                        )}
                    </div>

                    <div className="piano-container">
                        <div className="octave-selector">
                            {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(octave => (
                                <button
                                    key={octave}
                                    className={`octave-btn ${currentOctave === octave ? 'active' : ''}`}
                                    onClick={() => setCurrentOctave(octave)}
                                >
                                    Octave {octave}
                                </button>
                            ))}
                        </div>

                        <div className="piano-keyboard">
                            {renderOctaveKeys(currentOctave)}
                        </div>
                    </div>

                    <div className="visualization">
                        <h3>Frequency Spectrum</h3>
                        <div className="frequency-bars">
                            {frequencyData.map((value, index) => {
                                const normalizedValue = ((value + 100) / 100) * 100;
                                return (
                                    <div 
                                        key={index}
                                        className="frequency-bar"
                                        style={{ height: `${Math.max(normalizedValue, 2)}%` }}
                                    />
                                );
                            })}
                        </div>
                        <div className="midi-info">
                            Active Notes: {Array.from(activeNotes).join(', ') || 'None'}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PianoApp />, document.getElementById('root'));
    </script>
</body>
</html>
